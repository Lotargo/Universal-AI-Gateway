# User Configuration Guide

This guide explains how to use the **User Configuration Overrides** feature in Universal AI Gateway. This feature allows administrators to personalize settings for specific users or test new configurations without affecting the global system.

## Overview

By default, all users share the global configuration defined in `core/config/default_config.py` (generated by the DSL). The User Configuration Overrides feature allows you to inject specific settings into a user's profile in the database. These settings are **merged** on top of the global configuration at runtime.

## How Merging Works (Critical)

The system uses a **Deep Merge** strategy, but with an important distinction between Dictionaries and Lists:

1.  **Dictionaries (`dict`) are Merged:**
    *   If the global config has `{"a": 1, "b": 2}` and you override with `{"b": 3}`, the result is `{"a": 1, "b": 3}`.
    *   This makes it safe to tweak nested settings like toggles or individual router aliases.

2.  **Lists (`list`) are Replaced:**
    *   If the global config has `model_list: [A, B, C]` and you override with `model_list: [D]`, the result is `model_list: [D]`.
    *   **WARNING:** This means overriding lists like `model_list` or `mcp_servers` will **delete** all global items for that user. This breaks the application unless you manually copy the entire global list into your override.

## Safe Usage Examples

### 1. Feature Toggles (Recommended)
You can easily enable or disable specific features for a user.

**Disable Smart Search for a specific user:**
```json
{
  "enable_smart_search": false
}
```

**Disable specific tools:**
```json
{
  "native_tool_toggles": {
    "web_search": false,
    "calculator": true
  }
}
```

## MCP Tool Management

Universal AI Gateway automatically discovers and manages tools provided by connected MCP (Model Context Protocol) servers.

### Configuration File
All MCP tool settings are stored in a JSON file:
`core/config/mcp_tools.json`

This file is created automatically when the server starts for the first time.

### Auto-Discovery
1. At startup, the `MCPServerManager` polls all configured MCP servers.
2. Newly discovered tools are automatically added to `core/config/mcp_tools.json` with `enabled: true`.
3. **Persistence:** If a tool already exists in the file, the system **does not overwrite** its status. This allows you to disable a tool once, and it will remain disabled even after restarts.

### How to Disable a Tool
To hide a specific MCP tool from agents (e.g., `filesystem` access or dangerous commands), edit the `core/config/mcp_tools.json` file:

**Example:**
```json
{
  "tools": {
    "local-dev-server": {
      "filesystem::write_file": {
        "enabled": false,
        "description": "Writes to file (Disabled for safety)"
      }
    }
  }
}
```
Set `"enabled": false` for the target tool.

### Hot Reload
You **do not need to restart the server** after editing `mcp_tools.json`. The system automatically detects file changes (usually within 2-3 seconds) and updates the list of available tools in memory. Agents will stop seeing the disabled tools immediately.

### 2. Router Overrides (Personalized Routing)
You can change which model responds to a specific alias for a user. This is useful for testing or cost optimization (e.g., forcing a heavy user to a cheaper model).

**Force `gpt-4o` alias to use `gpt-3.5-turbo`:**
```json
{
  "router_settings": {
    "model_group_alias": {
      "gpt-4o": ["gpt-3.5-turbo-profile"]
    }
  }
}
```
*Note: This works because `model_group_alias` is a dictionary. Only the specific key `gpt-4o` is updated; others remain distinct.*

## Dangerous Usage (Proceed with Caution)

**Overriding `model_list`**
The `model_list` is generated dynamically by the complex DSL. If you override it, you lose all generated agents and models.

**BAD Example (Breaks the user):**
```json
{
  "model_list": [
    { "model_name": "my-custom-model", "provider": "openai" }
  ]
}
```
*Result: The user sees ONLY `my-custom-model`. All standard models (GPT-4, Claude, Gemini, etc.) disappear.*

## How to Edit Configuration

Currently, there is no UI for editing these overrides. You must edit the database directly.

**Recommended Tools:**
1.  **MongoDB Compass** (Official GUI)
2.  **MongoDB for VS Code** (Plugin)

**Steps:**
1.  Connect to your MongoDB instance (default: `mongodb://localhost:27017`).
2.  Navigate to database: `magic_proxy_db`.
3.  Open collection: `users`.
4.  Find the target user document.
5.  Add or edit the field `config_overrides`.

**Example Document Structure:**
```json
{
  "_id": "...",
  "username": "admin",
  "config_overrides": {
      "enable_smart_search": true,
      "router_settings": {
          "model_group_alias": {
              "test-alias": ["experimental-model-profile"]
          }
      }
  }
}
```
